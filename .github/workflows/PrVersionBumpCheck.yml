name: PR Version Bump Check

on:
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  version-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Validate version bump
        run: |
          python - <<'EOF'
          import os
          import re
          import subprocess
          import sys
          from pathlib import Path

          VERSION_FILE = Path("quasarr/providers/version.py")
          GITHUB_STEP_SUMMARY = os.environ.get("GITHUB_STEP_SUMMARY", "")
          COMMENT_FILE = Path("pr_comment.md")

          def write_summary(content: str):
              if GITHUB_STEP_SUMMARY:
                  with open(GITHUB_STEP_SUMMARY, "a") as f:
                      f.write(content + "\n")
              with open(COMMENT_FILE, "a") as f:
                  f.write(content + "\n")

          def gh_error(msg: str):
              print(f"::error::{msg}")

          def gh_notice(msg: str):
              print(f"::notice::{msg}")

          def load_version_from_path(path: Path):
              content = path.read_text()
              # Updated regex to match the new __version__ variable assignment
              match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', content)
              if not match:
                  # Fallback to old pattern just in case
                  match = re.search(r'def get_version\(\):\s*return\s*["\']([^"\']+)["\']', content)
          
              if not match:
                  raise ValueError(f"Could not find version string in {path}")
              return match.group(1)

          def parse(v):
              m = re.match(r"^(\d+)\.(\d+)\.(\d+)(?:a(\d+))?$", v)
              if not m:
                  raise ValueError(f"Invalid version: {v}")
              major, minor, patch, alpha = m.groups()
              alpha_num = int(alpha) if alpha else float('inf')
              return (int(major), int(minor), int(patch), alpha_num)

          def format_version_type(v):
              if "a" in v:
                  return f"`{v}` (alpha)"
              return f"`{v}` (release)"

          subprocess.run(["git", "fetch", "origin"], check=True, capture_output=True)

          base_ref = subprocess.check_output(
              ["git", "merge-base", "HEAD", "origin/main"],
              text=True
          ).strip()

          subprocess.run(
              ["git", "checkout", base_ref, "--", str(VERSION_FILE)],
              check=True,
              capture_output=True
          )

          base_version = load_version_from_path(VERSION_FILE)

          subprocess.run(
              ["git", "checkout", "HEAD", "--", str(VERSION_FILE)],
              check=True,
              capture_output=True
          )

          pr_version = load_version_from_path(VERSION_FILE)

          print(f"Base version: {base_version}")
          print(f"PR version:   {pr_version}")

          base_parsed = parse(base_version)
          pr_parsed = parse(pr_version)

          if pr_parsed <= base_parsed:
              gh_error(f"Version not bumped: {base_version} → {pr_version}")
          
              write_summary("## ❌ Version Bump Check Failed\n")
              write_summary(f"| Branch | Version |")
              write_summary(f"|--------|---------|")
              write_summary(f"| `main` | {format_version_type(base_version)} |")
              write_summary(f"| PR | {format_version_type(pr_version)} |")
              write_summary("")
          
              if pr_parsed == base_parsed:
                  write_summary(f"**Problem:** Version unchanged at `{pr_version}`")
              else:
                  write_summary(f"**Problem:** PR version `{pr_version}` is lower than base `{base_version}`")
          
              write_summary("")
              write_summary("Please update `quasarr/providers/version.py` with an incremented version.")
          
              sys.exit(1)

          gh_notice(f"Version bumped: {base_version} → {pr_version}")
          
          write_summary("## ✅ Version Bump Check Passed\n")
          write_summary(f"| Branch | Version |")
          write_summary(f"|--------|---------|")
          write_summary(f"| `main` | {format_version_type(base_version)} |")
          write_summary(f"| PR | {format_version_type(pr_version)} |")
          EOF

      - name: Comment on PR
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh pr comment ${{ github.event.pull_request.number }} --body-file pr_comment.md
